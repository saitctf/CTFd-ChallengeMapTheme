import{m as o,C as l,h as w,T as d,d as m,M as f,a as y}from"./index.b6be5691.js";function v(){return new Promise((e,t)=>{const a=()=>window.$||window.jQuery,i=a();if(window.Raphael&&i&&i.mapael&&i.mapael.maps&&i.mapael.maps.canada_provinces){e();return}let s=0;const n=100,c=setInterval(()=>{s++;const r=a();if(window.Raphael&&r&&r.mapael&&r.mapael.maps&&r.mapael.maps.canada_provinces)clearInterval(c),e();else if(s>=n){clearInterval(c),console.error("Map libraries not loaded after waiting"),console.log("Raphael:",!!window.Raphael),console.log("jQuery ($):",!!window.$),console.log("jQuery (jQuery):",!!window.jQuery);const h=a();console.log("Mapael:",!!(h&&h.mapael)),console.log("Available maps:",h&&h.mapael&&h.mapael.maps?Object.keys(h.mapael.maps):"none"),t(new Error("Map libraries not loaded"))}},100)})}function p(e){let a=new DOMParser().parseFromString(e,"text/html");return a.querySelectorAll('a[href*="://"]').forEach(s=>{s.setAttribute("target","_blank")}),a.documentElement.outerHTML}window.Alpine=o;o.store("challenge",{data:{view:""}});o.data("Hint",()=>({id:null,html:null,async showHint(e){if(e.target.open){let t=await l.pages.challenge.loadHint(this.id);if(t.errors){e.target.open=!1,l._functions.challenge.displayUnlockError(t);return}let a=t.data;if(a.content)this.html=p(a.html);else if(await l.pages.challenge.displayUnlock(this.id)){let s=await l.pages.challenge.loadUnlock(this.id);if(s.success){let c=(await l.pages.challenge.loadHint(this.id)).data;this.html=p(c.html)}else e.target.open=!1,l._functions.challenge.displayUnlockError(s)}else e.target.open=!1}}}));o.data("Challenge",()=>({id:null,next_id:null,submission:"",tab:null,solves:[],submissions:[],solution:null,response:null,share_url:null,max_attempts:0,attempts:0,ratingValue:0,hoveredRating:0,selectedRating:0,ratingReview:"",ratingSubmitted:!1,async init(){w()},getStyles(){let e={"modal-dialog":!0};try{switch(l.config.themeSettings.challenge_window_size){case"sm":e["modal-sm"]=!0;break;case"lg":e["modal-lg"]=!0;break;case"xl":e["modal-xl"]=!0;break;default:break}}catch(t){console.log("Error processing challenge_window_size"),console.log(t)}return e},async showChallenge(){new d(this.$el).show()},async showSolves(){this.solves=await l.pages.challenge.loadSolves(this.id),this.solves.forEach(e=>(e.date=m(e.date).format("MMMM Do, h:mm:ss A"),e)),new d(this.$el).show()},async showSubmissions(){let e=await l.pages.users.userSubmissions("me",this.id);this.submissions=e.data,this.submissions.forEach(t=>(t.date=m(t.date).format("MMMM Do, h:mm:ss A"),t)),new d(this.$el).show()},getSolutionId(){return o.store("challenge").data.solution_id},async showSolution(){let e=this.getSolutionId();l._functions.challenge.displaySolution=t=>{this.solution=t.html,new d(this.$el).show()},await l.pages.challenge.displaySolution(e)},getNextId(){return o.store("challenge").data.next_id},async nextChallenge(){let e=f.getOrCreateInstance("[x-ref='challengeWindow']");e._element.addEventListener("hidden.bs.modal",t=>{o.nextTick(()=>{this.$dispatch("load-challenge",this.getNextId())})},{once:!0}),e.hide()},async getShareUrl(){let e={type:"solve",challenge_id:this.id};const i=(await(await l.fetch("/api/v1/shares",{method:"POST",body:JSON.stringify(e)})).json()).data.url;this.share_url=i},copyShareUrl(){navigator.clipboard.writeText(this.share_url);let e=y.getOrCreateInstance(this.$el);e.enable(),e.show(),setTimeout(()=>{e.hide(),e.disable()},2e3)},async submitChallenge(){this.response=await l.pages.challenge.submitChallenge(this.id,this.submission),await this.renderSubmissionResponse()},async renderSubmissionResponse(){this.response.data.status==="correct"&&(this.submission=""),this.max_attempts>0&&this.response.data.status!="already_solved"&&this.response.data.status!="ratelimited"&&(this.attempts+=1),this.$dispatch("load-challenges")},async submitRating(){(await l.pages.challenge.submitRating(this.id,this.selectedRating,this.ratingReview)).value?(this.ratingValue=this.selectedRating,this.ratingSubmitted=!0):alert("Error submitting rating")}}));o.data("ChallengeMap",()=>({loaded:!1,challenges:[],challenge:null,provinces:{},provinces_used:[],chal_areas:{},categories:[],category_colors:[],async init(){try{if(this.challenges=await l.pages.challenges.getChallenges(),await v().catch(e=>{console.error("Failed to load map libraries:",e),this.loaded=!0}),this.loaded=!0,this.initializeMap(),window.location.hash){let e=decodeURIComponent(window.location.hash.substring(1)),t=e.lastIndexOf("-");if(t>=0){let i=[e.slice(0,t),e.slice(t+1)][1];await this.loadChallenge(i)}}}catch(e){console.error("Error initializing challenge map:",e),this.loaded=!0}},initializeMap(){this.provinces={AB:1,BC:2,MB:3,NB:4,NL:5,NS:6,ON:7,PE:8,QC:9,SK:10,NT:11,NU:12,YT:13},this.provinces_used=[],this.chal_areas={},this.categories=[],this.category_colors=[],this.mapChallengesToProvinces(),this.createMap()},mapChallengesToProvinces(){const e=Object.keys(this.provinces),t={};this.challenges.forEach(a=>{this.categories.includes(a.category)||this.categories.push(a.category),t[a.category]||(t[a.category]=[]),t[a.category].push(a)}),this.categories.forEach((a,i)=>{const s=e[i%e.length];if(!this.provinces_used.includes(s)){const n=t[a];if(n&&n.length>0){const c=n[0];this.chal_areas[s]={value:a,tooltip:{content:`<span style="font-weight:bold;">${a}</span><br/>${n.length} challenge${n.length>1?"s":""}`}},this.provinces_used.push(s),this.provinces[s]=c.id}}}),this.challenges.forEach(a=>{a.tags.forEach(i=>{const s=i.value.toUpperCase();this.provinces.hasOwnProperty(s)&&!this.provinces_used.includes(s)&&(this.chal_areas[s]={value:a.category,tooltip:{content:`<span style="font-weight:bold;">${a.category} ${parseInt(a.value)}: ${a.name}</span>`}},this.provinces_used.push(s),this.provinces[s]=a.id)})}),this.categories.forEach(a=>{this.category_colors.push({attrs:{fill:this.colorHash(a)},label:a,sliceValue:a})}),Object.keys(this.chal_areas).length===0&&console.log("No challenges found, showing empty map")},colorHash(e){let t=0;for(let s=0;s<e.length;s++)t+=e.charCodeAt(s);let a="";const i=t/8;for(let s=i;s<=t&&(a+=s.toString(16).replace(/\W/g,""),!(a.length>=6));s+=i);return"#"+a.substring(0,6)},createMap(){const e=this;this.$nextTick(()=>{const t=a=>{const i=window.$||window.jQuery;i?a(i):setTimeout(()=>t(a),50)};t(a=>{a(function(){const i=()=>{const s=e.$refs.mapContainer;if(!s){console.error("Map container not found");return}const n=a(s);if(!(n.is(":visible")&&n.width()>0&&n.height()>0)){setTimeout(i,100);return}if(!a.mapael){console.error("jQuery Mapael not loaded");return}if(!a.mapael.maps||!a.mapael.maps.canada_provinces){console.error("Canada provinces map definition not found"),console.log("Available maps:",a.mapael.maps?Object.keys(a.mapael.maps):"none");return}try{const r={map:{name:"canada_provinces",cssClass:"map",defaultArea:{attrs:{fill:"#eee",stroke:"#ddd",strokeWidth:1,cursor:"pointer"},text:{attrs:{"font-size":10,"font-family":"Arial, Helvetica, sans-serif"},attrsHover:{"font-size":14,"font-family":"Arial, Helvetica, sans-serif"}},attrsHover:{animDuration:200,fill:"#555"},eventHandlers:{click:(h,g,b,_)=>{if(!e.provinces_used.includes(g)){console.log("Province",g,"has no challenges assigned");return}const u=e.provinces[g];u&&e.loadChallenge(u)}}}},legend:{area:{title:"Categories",slices:e.category_colors}},areas:e.chal_areas};console.log("Creating map with config:",r),console.log("Areas to render:",Object.keys(e.chal_areas)),console.log("Map container:",s),console.log("Container dimensions:",n.width(),"x",n.height()),a(s).mapael(r),console.log("Map created successfully")}catch(r){console.error("Error creating map:",r),console.error("Error stack:",r.stack)}};i()})})})},async loadChallenges(){this.challenges=await l.pages.challenges.getChallenges(),this.initializeMap()},async loadChallenge(e){await l.pages.challenge.displayChallenge(e,t=>{t.data.view=p(t.data.view),o.store("challenge").data=t.data,o.nextTick(()=>{let a=f.getOrCreateInstance("[x-ref='challengeWindow']");a._element.addEventListener("hidden.bs.modal",i=>{history.replaceState(null,null," ")},{once:!0}),a.show(),history.replaceState(null,null,`#${t.data.name}-${e}`)})})}}));o.start();
