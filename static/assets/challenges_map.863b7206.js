import{m as d,C as r,h as x,T as v,d as I,M as _,a as k}from"./index.b6be5691.js";function C(){return new Promise((e,l)=>{const s=()=>window.$||window.jQuery,t=s();if(window.Raphael&&t&&t.mapael&&t.mapael.maps&&t.mapael.maps.islands){e();return}let n=0;const a=100,o=setInterval(()=>{n++;const c=s();if(window.Raphael&&c&&c.mapael&&c.mapael.maps&&c.mapael.maps.islands)clearInterval(o),e();else if(n>=a){clearInterval(o),console.error("Map libraries not loaded after waiting"),console.log("Raphael:",!!window.Raphael),console.log("jQuery ($):",!!window.$),console.log("jQuery (jQuery):",!!window.jQuery);const i=s();console.log("Mapael:",!!(i&&i.mapael)),console.log("Available maps:",i&&i.mapael&&i.mapael.maps?Object.keys(i.mapael.maps):"none"),l(new Error("Map libraries not loaded"))}},100)})}function S(e){let s=new DOMParser().parseFromString(e,"text/html");return s.querySelectorAll('a[href*="://"]').forEach(n=>{n.setAttribute("target","_blank")}),s.documentElement.outerHTML}window.Alpine=d;d.store("challenge",{data:{view:""}});d.data("Hint",()=>({id:null,html:null,async showHint(e){if(e.target.open){let l=await r.pages.challenge.loadHint(this.id);if(l.errors){e.target.open=!1,r._functions.challenge.displayUnlockError(l);return}let s=l.data;if(s.content)this.html=S(s.html);else if(await r.pages.challenge.displayUnlock(this.id)){let n=await r.pages.challenge.loadUnlock(this.id);if(n.success){let o=(await r.pages.challenge.loadHint(this.id)).data;this.html=S(o.html)}else e.target.open=!1,r._functions.challenge.displayUnlockError(n)}else e.target.open=!1}}}));d.data("Challenge",()=>({id:null,next_id:null,submission:"",tab:null,solves:[],submissions:[],solution:null,response:null,share_url:null,max_attempts:0,attempts:0,ratingValue:0,hoveredRating:0,selectedRating:0,ratingReview:"",ratingSubmitted:!1,async init(){x()},getStyles(){let e={"modal-dialog":!0};try{switch(r.config.themeSettings.challenge_window_size){case"sm":e["modal-sm"]=!0;break;case"lg":e["modal-lg"]=!0;break;case"xl":e["modal-xl"]=!0;break;default:break}}catch(l){console.log("Error processing challenge_window_size"),console.log(l)}return e},async showChallenge(){new v(this.$el).show()},async showSolves(){this.solves=await r.pages.challenge.loadSolves(this.id),this.solves.forEach(e=>(e.date=I(e.date).format("MMMM Do, h:mm:ss A"),e)),new v(this.$el).show()},async showSubmissions(){let e=await r.pages.users.userSubmissions("me",this.id);this.submissions=e.data,this.submissions.forEach(l=>(l.date=I(l.date).format("MMMM Do, h:mm:ss A"),l)),new v(this.$el).show()},getSolutionId(){return d.store("challenge").data.solution_id},async showSolution(){let e=this.getSolutionId();r._functions.challenge.displaySolution=l=>{this.solution=l.html,new v(this.$el).show()},await r.pages.challenge.displaySolution(e)},getNextId(){return d.store("challenge").data.next_id},async nextChallenge(){let e=_.getOrCreateInstance("[x-ref='challengeWindow']");e._element.addEventListener("hidden.bs.modal",l=>{d.nextTick(()=>{this.$dispatch("load-challenge",this.getNextId())})},{once:!0}),e.hide()},async getShareUrl(){let e={type:"solve",challenge_id:this.id};const t=(await(await r.fetch("/api/v1/shares",{method:"POST",body:JSON.stringify(e)})).json()).data.url;this.share_url=t},copyShareUrl(){navigator.clipboard.writeText(this.share_url);let e=k.getOrCreateInstance(this.$el);e.enable(),e.show(),setTimeout(()=>{e.hide(),e.disable()},2e3)},async submitChallenge(){this.response=await r.pages.challenge.submitChallenge(this.id,this.submission),await this.renderSubmissionResponse()},async renderSubmissionResponse(){this.response.data.status==="correct"&&(this.submission=""),this.max_attempts>0&&this.response.data.status!="already_solved"&&this.response.data.status!="ratelimited"&&(this.attempts+=1),this.$dispatch("load-challenges")},async submitRating(){(await r.pages.challenge.submitRating(this.id,this.selectedRating,this.ratingReview)).value?(this.ratingValue=this.selectedRating,this.ratingSubmitted=!0):alert("Error submitting rating")}}));d.data("ChallengeMap",()=>({loaded:!1,challenges:[],challenge:null,provinces:{},provinces_used:[],chal_areas:{},categories:[],category_colors:[],province_challenges:{},chal_plots:{},province_centers:{},async init(){try{if(this.challenges=await r.pages.challenges.getChallenges(),await C().catch(e=>{console.error("Failed to load map libraries:",e),this.loaded=!0}),this.loaded=!0,this.initializeMap(),window.location.hash){let e=decodeURIComponent(window.location.hash.substring(1)),l=e.lastIndexOf("-");if(l>=0){let t=[e.slice(0,l),e.slice(l+1)][1];await this.loadChallenge(t)}}}catch(e){console.error("Error initializing challenge map:",e),this.loaded=!0}},initializeMap(){this.provinces={ISLAND1:1,ISLAND2:2,ISLAND3:3,ISLAND4:4,ISLAND5:5,ISLAND6:6,ISLAND7:7,ISLAND8:8,ISLAND9:9,ISLAND10:10,ISLAND11:11,ISLAND12:12,ISLAND13:13},this.province_centers={ISLAND1:{x:190,y:200},ISLAND2:{x:450,y:180},ISLAND3:{x:740,y:200},ISLAND4:{x:245,y:400},ISLAND5:{x:505,y:380},ISLAND6:{x:765,y:400},ISLAND7:{x:225,y:600},ISLAND8:{x:530,y:580},ISLAND9:{x:795,y:600},ISLAND10:{x:115,y:450},ISLAND11:{x:885,y:450},ISLAND12:{x:80,y:250},ISLAND13:{x:920,y:250}},this.provinces_used=[],this.chal_areas={},this.categories=[],this.category_colors=[],this.province_challenges={},this.chal_plots={},this.mapChallengesToProvinces(),this.createMap()},mapChallengesToProvinces(){const e=Object.keys(this.provinces),l={},s={};this.challenges.forEach((t,n)=>{this.categories.includes(t.category)||this.categories.push(t.category);let a=null;const o=this.categories.indexOf(t.category);a=e[o%e.length],l[t.category]||(l[t.category]=a,this.provinces_used.includes(a)||this.provinces_used.push(a),s[a]||(s[a]=[]),this.chal_areas[a]={value:t.category,tooltip:{content:`<span style="font-weight:bold;">${t.category}</span>`}},this.provinces[a]=t.id),s[a]||(s[a]=[]),s[a].push(t),this.province_challenges[a]||(this.province_challenges[a]=[]),this.province_challenges[a].includes(t.id)||this.province_challenges[a].push(t.id);const c=this.province_centers[a];if(c){const i=s[a],g=i.indexOf(t),u=i.length,h=Math.ceil(Math.sqrt(u)),m=Math.floor(g/h),p=(g%h-(h-1)/2)*25,w=(m-Math.floor((u-1)/h)/2)*25,b=`chal_${t.id}`,f=t.solved_by_me||!1;this.chal_plots[b]={x:c.x+p,y:c.y+w,size:12,type:"circle",attrs:{fill:f?"#0066b1":"#fff773",stroke:"#8b5c29","stroke-width":2,opacity:f?.8:1},attrsHover:{opacity:1,fill:f?"#0088dd":"#ffff99","stroke-width":3},tooltip:{content:`<span style="font-weight:bold;">${t.name}</span><br/>${parseInt(t.value)} points<br/>${t.category}${f?'<br/><span style="color:#0066b1;">\u2713 Solved</span>':""}`},challengeId:t.id,isSolved:f}}}),this.challenges.forEach(t=>{t.tags.forEach(n=>{const a=n.value.toUpperCase();if(this.provinces.hasOwnProperty(a)){const o=l[t.category];if(o&&this.province_challenges[o]){const i=this.province_challenges[o].indexOf(t.id);i>-1&&this.province_challenges[o].splice(i,1)}this.province_challenges[a]||(this.province_challenges[a]=[]),this.province_challenges[a].includes(t.id)||this.province_challenges[a].push(t.id);const c=`chal_${t.id}`;if(this.chal_plots[c]&&this.province_centers[a]){const i=this.province_centers[a],g=this.province_challenges[a],u=g.indexOf(t.id),h=g.length,m=Math.ceil(Math.sqrt(h)),y=Math.floor(u/m),w=(u%m-(m-1)/2)*25,b=(y-Math.floor((h-1)/m)/2)*25;this.chal_plots[c].x=i.x+w,this.chal_plots[c].y=i.y+b}this.provinces_used.includes(a)||(this.chal_areas[a]={value:t.category,tooltip:{content:`<span style="font-weight:bold;">${t.category} ${parseInt(t.value)}: ${t.name}</span>`}},this.provinces_used.push(a),this.provinces[a]=t.id)}})}),this.categories.forEach(t=>{this.category_colors.push({attrs:{fill:this.colorHash(t)},label:t,sliceValue:t})}),Object.keys(this.chal_areas).length===0&&console.log("No challenges found, showing empty map")},colorHash(e){let l=0;for(let n=0;n<e.length;n++)l+=e.charCodeAt(n);let s="";const t=l/8;for(let n=t;n<=l&&(s+=n.toString(16).replace(/\W/g,""),!(s.length>=6));n+=t);return"#"+s.substring(0,6)},createMap(){const e=this,l=()=>{const s=e.$refs.mapContainer;if(!s){setTimeout(l,50);return}const t=window.$||window.jQuery;if(!t){setTimeout(l,50);return}const n=t(s),a=n.find(".map"),o=n.is(":visible")&&n.width()>0&&n.height()>0&&window.getComputedStyle(s).display!=="none",c=a.length>0&&a.is(":visible")&&window.getComputedStyle(a[0]).display!=="none";if(!o||!c){setTimeout(l,100);return}if(!t.mapael){console.error("jQuery Mapael not loaded");return}if(!t.mapael.maps||!t.mapael.maps.islands){console.error("Islands map definition not found"),console.log("Available maps:",t.mapael.maps?Object.keys(t.mapael.maps):"none");return}try{const i={map:{name:"islands",cssClass:"map",defaultArea:{attrs:{fill:"#8b5c29",stroke:"#ffe1ba",strokeWidth:2,cursor:"pointer"},text:{attrs:{"font-size":12,"font-family":"Arial, Helvetica, sans-serif",fill:"#fff773"},attrsHover:{"font-size":14,"font-family":"Arial, Helvetica, sans-serif",fill:"#fff773"}},attrsHover:{animDuration:200,fill:"#a66d3a"},eventHandlers:{click:(u,h,m,y)=>{if(!e.provinces_used.includes(h)){console.log("Province",h,"has no challenges assigned");return}const p=e.province_challenges[h]||[e.provinces[h]];p.length===1?e.loadChallenge(p[0]):e.showChallengeSelection(h,p)}}},defaultPlot:{size:12,attrs:{fill:"#fff773",stroke:"#8b5c29","stroke-width":2},attrsHover:{opacity:1,fill:"#ffff99","stroke-width":3},eventHandlers:{click:function(u,h,m,y){const p=e.chal_plots[h];p&&p.challengeId&&e.loadChallenge(p.challengeId)}}}},legend:{area:{title:"Categories",slices:e.category_colors}},areas:e.chal_areas,plots:e.chal_plots};console.log("Creating map with config:",i),console.log("Areas to render:",Object.keys(e.chal_areas)),console.log("Plots to render:",Object.keys(e.chal_plots)),console.log("Map container:",s),console.log("Container dimensions:",n.width(),"x",n.height()),console.log("Map div dimensions:",a.width(),"x",a.height());const g=t(s).mapael(i);setTimeout(()=>{e.addCheckmarksToSolvedChallenges(t(s))},200),console.log("Map created successfully")}catch(i){console.error("Error creating map:",i),console.error("Error stack:",i.stack)}};this.$nextTick(()=>{setTimeout(l,100)})},async loadChallenges(){this.challenges=await r.pages.challenges.getChallenges(),this.initializeMap()},async showChallengeSelection(e,l){const s=this.challenges.filter(i=>l.includes(i.id));if(s.length===0)return;const t=`
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Select Challenge - ${e}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>This province has ${s.length} challenge${s.length>1?"s":""}:</p>
            <div class="list-group">
              ${s.map(i=>`
                <button type="button" class="list-group-item list-group-item-action" data-challenge-id="${i.id}">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${i.name}</h6>
                    <small>${parseInt(i.value)} points</small>
                  </div>
                  <p class="mb-1">${i.category}</p>
                </button>
              `).join("")}
            </div>
          </div>
        </div>
      </div>
    `,n=document.createElement("div");n.className="modal fade",n.id="challenge-selection-modal",n.innerHTML=t,document.body.appendChild(n);const a=new _(n,{backdrop:!0,keyboard:!0});let o=null;n.querySelectorAll("[data-challenge-id]").forEach(i=>{i.addEventListener("click",()=>{o=parseInt(i.getAttribute("data-challenge-id")),a.hide()})});const c=i=>{o&&setTimeout(()=>{this.loadChallenge(o)},150);try{a.dispose()}catch{}requestAnimationFrame(()=>{requestAnimationFrame(()=>{try{n&&n.isConnected&&n.parentNode&&n.remove()}catch{}})})};n.addEventListener("hidden.bs.modal",c,{once:!0}),a.show()},addCheckmarksToSolvedChallenges(e){Object.keys(this.chal_plots).forEach(l=>{const s=this.chal_plots[l];if(s&&s.isSolved){const t=e.data("mapael");if(t&&t.paper){const a=t.paper.path(`M ${s.x-10},${s.y} L ${s.x-2},${s.y+8} L ${s.x+10},${s.y-8}`).attr({stroke:"#0066b1","stroke-width":4,"stroke-linecap":"round","stroke-linejoin":"round",fill:"none"});s.checkmark=a}}})},async loadChallenge(e){await r.pages.challenge.displayChallenge(e,l=>{l.data.view=S(l.data.view),d.store("challenge").data=l.data,d.nextTick(()=>{let s=_.getOrCreateInstance("[x-ref='challengeWindow']");s._element.addEventListener("hidden.bs.modal",t=>{history.replaceState(null,null," "),self.initializeMap()},{once:!0}),s.show(),history.replaceState(null,null,`#${l.data.name}-${e}`)})})}}));d.start();
