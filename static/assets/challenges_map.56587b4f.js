import{m as h,C as r,h as _,T as u,d as w,M as y,a as C}from"./index.b6be5691.js";function k(){return new Promise((e,a)=>{const t=()=>window.$||window.jQuery,l=t();if(window.Raphael&&l&&l.mapael&&l.mapael.maps&&l.mapael.maps.canada_provinces){e();return}let s=0;const i=100,c=setInterval(()=>{s++;const o=t();if(window.Raphael&&o&&o.mapael&&o.mapael.maps&&o.mapael.maps.canada_provinces)clearInterval(c),e();else if(s>=i){clearInterval(c),console.error("Map libraries not loaded after waiting"),console.log("Raphael:",!!window.Raphael),console.log("jQuery ($):",!!window.$),console.log("jQuery (jQuery):",!!window.jQuery);const n=t();console.log("Mapael:",!!(n&&n.mapael)),console.log("Available maps:",n&&n.mapael&&n.mapael.maps?Object.keys(n.mapael.maps):"none"),a(new Error("Map libraries not loaded"))}},100)})}function v(e){let t=new DOMParser().parseFromString(e,"text/html");return t.querySelectorAll('a[href*="://"]').forEach(s=>{s.setAttribute("target","_blank")}),t.documentElement.outerHTML}window.Alpine=h;h.store("challenge",{data:{view:""}});h.data("Hint",()=>({id:null,html:null,async showHint(e){if(e.target.open){let a=await r.pages.challenge.loadHint(this.id);if(a.errors){e.target.open=!1,r._functions.challenge.displayUnlockError(a);return}let t=a.data;if(t.content)this.html=v(t.html);else if(await r.pages.challenge.displayUnlock(this.id)){let s=await r.pages.challenge.loadUnlock(this.id);if(s.success){let c=(await r.pages.challenge.loadHint(this.id)).data;this.html=v(c.html)}else e.target.open=!1,r._functions.challenge.displayUnlockError(s)}else e.target.open=!1}}}));h.data("Challenge",()=>({id:null,next_id:null,submission:"",tab:null,solves:[],submissions:[],solution:null,response:null,share_url:null,max_attempts:0,attempts:0,ratingValue:0,hoveredRating:0,selectedRating:0,ratingReview:"",ratingSubmitted:!1,async init(){_()},getStyles(){let e={"modal-dialog":!0};try{switch(r.config.themeSettings.challenge_window_size){case"sm":e["modal-sm"]=!0;break;case"lg":e["modal-lg"]=!0;break;case"xl":e["modal-xl"]=!0;break;default:break}}catch(a){console.log("Error processing challenge_window_size"),console.log(a)}return e},async showChallenge(){new u(this.$el).show()},async showSolves(){this.solves=await r.pages.challenge.loadSolves(this.id),this.solves.forEach(e=>(e.date=w(e.date).format("MMMM Do, h:mm:ss A"),e)),new u(this.$el).show()},async showSubmissions(){let e=await r.pages.users.userSubmissions("me",this.id);this.submissions=e.data,this.submissions.forEach(a=>(a.date=w(a.date).format("MMMM Do, h:mm:ss A"),a)),new u(this.$el).show()},getSolutionId(){return h.store("challenge").data.solution_id},async showSolution(){let e=this.getSolutionId();r._functions.challenge.displaySolution=a=>{this.solution=a.html,new u(this.$el).show()},await r.pages.challenge.displaySolution(e)},getNextId(){return h.store("challenge").data.next_id},async nextChallenge(){let e=y.getOrCreateInstance("[x-ref='challengeWindow']");e._element.addEventListener("hidden.bs.modal",a=>{h.nextTick(()=>{this.$dispatch("load-challenge",this.getNextId())})},{once:!0}),e.hide()},async getShareUrl(){let e={type:"solve",challenge_id:this.id};const l=(await(await r.fetch("/api/v1/shares",{method:"POST",body:JSON.stringify(e)})).json()).data.url;this.share_url=l},copyShareUrl(){navigator.clipboard.writeText(this.share_url);let e=C.getOrCreateInstance(this.$el);e.enable(),e.show(),setTimeout(()=>{e.hide(),e.disable()},2e3)},async submitChallenge(){this.response=await r.pages.challenge.submitChallenge(this.id,this.submission),await this.renderSubmissionResponse()},async renderSubmissionResponse(){this.response.data.status==="correct"&&(this.submission=""),this.max_attempts>0&&this.response.data.status!="already_solved"&&this.response.data.status!="ratelimited"&&(this.attempts+=1),this.$dispatch("load-challenges")},async submitRating(){(await r.pages.challenge.submitRating(this.id,this.selectedRating,this.ratingReview)).value?(this.ratingValue=this.selectedRating,this.ratingSubmitted=!0):alert("Error submitting rating")}}));h.data("ChallengeMap",()=>({loaded:!1,challenges:[],challenge:null,provinces:{},provinces_used:[],chal_areas:{},categories:[],category_colors:[],province_challenges:{},chal_plots:{},province_centers:{},async init(){try{if(this.challenges=await r.pages.challenges.getChallenges(),await k().catch(e=>{console.error("Failed to load map libraries:",e),this.loaded=!0}),this.loaded=!0,this.initializeMap(),window.location.hash){let e=decodeURIComponent(window.location.hash.substring(1)),a=e.lastIndexOf("-");if(a>=0){let l=[e.slice(0,a),e.slice(a+1)][1];await this.loadChallenge(l)}}}catch(e){console.error("Error initializing challenge map:",e),this.loaded=!0}},initializeMap(){this.provinces={AB:1,BC:2,MB:3,NB:4,NL:5,NS:6,ON:7,PE:8,QC:9,SK:10,NT:11,NU:12,YT:13},this.province_centers={BC:{x:200,y:350},AB:{x:235,y:340},SK:{x:345,y:340},MB:{x:447,y:340},ON:{x:560,y:360},QC:{x:657,y:360},NB:{x:705,y:360},NS:{x:710,y:380},PE:{x:700,y:355},NL:{x:765,y:330},YT:{x:115,y:150},NT:{x:220,y:200},NU:{x:360,y:200}},this.provinces_used=[],this.chal_areas={},this.categories=[],this.category_colors=[],this.province_challenges={},this.chal_plots={},this.mapChallengesToProvinces(),this.createMap()},mapChallengesToProvinces(){const e=Object.keys(this.provinces),a={};this.challenges.forEach(t=>{this.categories.includes(t.category)||this.categories.push(t.category),a[t.category]||(a[t.category]=[]),a[t.category].push(t)}),this.categories.forEach((t,l)=>{const s=e[l%e.length];if(!this.provinces_used.includes(s)){const i=a[t];if(i&&i.length>0){this.province_challenges[s]=i.map(o=>o.id),this.chal_areas[s]={value:t,tooltip:{content:`<span style="font-weight:bold;">${t}</span><br/>${i.length} challenge${i.length>1?"s":""}`}},this.provinces_used.push(s),this.provinces[s]=i[0].id;const c=this.province_centers[s];c&&i.forEach((o,n)=>{const m=i.length>1?(n-(i.length-1)/2)*30:0,f=i.length>1?n%2*20:0,d=`chal_${o.id}`,g=o.solved_by_me||!1;this.chal_plots[d]={x:c.x+m,y:c.y+f,size:20,type:"svg",width:24,height:24,path:this.getFalloutIconPath(),attrs:{fill:g?"#0066b1":"#fff773",stroke:"#8b5c29","stroke-width":2,opacity:g?.8:1},attrsHover:{opacity:1,transform:"s1.2"},tooltip:{content:`<span style="font-weight:bold;">${o.name}</span><br/>${parseInt(o.value)} points<br/>${o.category}${g?'<br/><span style="color:#0066b1;">\u2713 Solved</span>':""}`},challengeId:o.id,isSolved:g}})}}}),this.challenges.forEach(t=>{t.tags.forEach(l=>{const s=l.value.toUpperCase();this.provinces.hasOwnProperty(s)&&!this.provinces_used.includes(s)&&(this.province_challenges[s]||(this.province_challenges[s]=[]),this.province_challenges[s].includes(t.id)||this.province_challenges[s].push(t.id),this.chal_areas[s]={value:t.category,tooltip:{content:`<span style="font-weight:bold;">${t.category} ${parseInt(t.value)}: ${t.name}</span>`}},this.provinces_used.push(s),this.provinces[s]=t.id)})}),this.categories.forEach(t=>{this.category_colors.push({attrs:{fill:this.colorHash(t)},label:t,sliceValue:t})}),Object.keys(this.chal_areas).length===0&&console.log("No challenges found, showing empty map")},colorHash(e){let a=0;for(let s=0;s<e.length;s++)a+=e.charCodeAt(s);let t="";const l=a/8;for(let s=l;s<=a&&(t+=s.toString(16).replace(/\W/g,""),!(t.length>=6));s+=l);return"#"+t.substring(0,6)},getFalloutIconPath(){return"M 12,2 L 12,6 M 12,18 L 12,22 M 2,12 L 6,12 M 18,12 L 22,12 M 4.343,4.343 L 7.071,7.071 M 16.929,16.929 L 19.657,19.657 M 4.343,19.657 L 7.071,16.929 M 16.929,7.071 L 19.657,4.343 M 12,8 A 4,4 0 0,1 12,16 A 4,4 0 0,1 12,8 Z"},createMap(){const e=this,a=()=>{const t=e.$refs.mapContainer;if(!t){setTimeout(a,50);return}const l=window.$||window.jQuery;if(!l){setTimeout(a,50);return}const s=l(t),i=s.find(".map"),c=s.is(":visible")&&s.width()>0&&s.height()>0&&window.getComputedStyle(t).display!=="none",o=i.length>0&&i.is(":visible")&&window.getComputedStyle(i[0]).display!=="none";if(!c||!o){setTimeout(a,100);return}if(!l.mapael){console.error("jQuery Mapael not loaded");return}if(!l.mapael.maps||!l.mapael.maps.canada_provinces){console.error("Canada provinces map definition not found"),console.log("Available maps:",l.mapael.maps?Object.keys(l.mapael.maps):"none");return}try{const n={map:{name:"canada_provinces",cssClass:"map",defaultArea:{attrs:{fill:"#001423",stroke:"#8b5c29",strokeWidth:1,cursor:"pointer"},text:{attrs:{"font-size":10,"font-family":"Arial, Helvetica, sans-serif"},attrsHover:{"font-size":14,"font-family":"Arial, Helvetica, sans-serif"}},attrsHover:{animDuration:200,fill:"#001a2e"},eventHandlers:{click:(f,d,g,b)=>{if(!e.provinces_used.includes(d)){console.log("Province",d,"has no challenges assigned");return}const p=e.province_challenges[d]||[e.provinces[d]];p.length===1?e.loadChallenge(p[0]):e.showChallengeSelection(d,p)}}},defaultPlot:{size:20,attrs:{fill:"#fff773",stroke:"#8b5c29","stroke-width":2},attrsHover:{opacity:1,transform:"s1.2"},eventHandlers:{click:function(f,d,g,b){const p=e.chal_plots[d];p&&p.challengeId&&e.loadChallenge(p.challengeId)}}}},legend:{area:{title:"Categories",slices:e.category_colors}},areas:e.chal_areas,plots:e.chal_plots};console.log("Creating map with config:",n),console.log("Areas to render:",Object.keys(e.chal_areas)),console.log("Plots to render:",Object.keys(e.chal_plots)),console.log("Map container:",t),console.log("Container dimensions:",s.width(),"x",s.height()),console.log("Map div dimensions:",i.width(),"x",i.height());const m=l(t).mapael(n);setTimeout(()=>{e.addCheckmarksToSolvedChallenges(l(t))},200),console.log("Map created successfully")}catch(n){console.error("Error creating map:",n),console.error("Error stack:",n.stack)}};this.$nextTick(()=>{setTimeout(a,100)})},async loadChallenges(){this.challenges=await r.pages.challenges.getChallenges(),this.initializeMap()},async showChallengeSelection(e,a){const t=this.challenges.filter(n=>a.includes(n.id));if(t.length===0)return;const l=`
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Select Challenge - ${e}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>This province has ${t.length} challenge${t.length>1?"s":""}:</p>
            <div class="list-group">
              ${t.map(n=>`
                <button type="button" class="list-group-item list-group-item-action" data-challenge-id="${n.id}">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${n.name}</h6>
                    <small>${parseInt(n.value)} points</small>
                  </div>
                  <p class="mb-1">${n.category}</p>
                </button>
              `).join("")}
            </div>
          </div>
        </div>
      </div>
    `,s=document.createElement("div");s.className="modal fade",s.id="challenge-selection-modal",s.innerHTML=l,document.body.appendChild(s);const i=new y(s,{backdrop:!0,keyboard:!0});let c=null;s.querySelectorAll("[data-challenge-id]").forEach(n=>{n.addEventListener("click",()=>{c=parseInt(n.getAttribute("data-challenge-id")),i.hide()})});const o=n=>{c&&setTimeout(()=>{this.loadChallenge(c)},150);try{i.dispose()}catch{}requestAnimationFrame(()=>{requestAnimationFrame(()=>{try{s&&s.isConnected&&s.parentNode&&s.remove()}catch{}})})};s.addEventListener("hidden.bs.modal",o,{once:!0}),i.show()},addCheckmarksToSolvedChallenges(e){Object.keys(this.chal_plots).forEach(a=>{const t=this.chal_plots[a];if(t&&t.isSolved){const l=e.data("mapael");if(l&&l.paper){const i=l.paper.path(`M ${t.x-10},${t.y} L ${t.x-2},${t.y+8} L ${t.x+10},${t.y-8}`).attr({stroke:"#0066b1","stroke-width":4,"stroke-linecap":"round","stroke-linejoin":"round",fill:"none"});t.checkmark=i}}})},async loadChallenge(e){await r.pages.challenge.displayChallenge(e,a=>{a.data.view=v(a.data.view),h.store("challenge").data=a.data,h.nextTick(()=>{let t=y.getOrCreateInstance("[x-ref='challengeWindow']");t._element.addEventListener("hidden.bs.modal",l=>{history.replaceState(null,null," "),self.initializeMap()},{once:!0}),t.show(),history.replaceState(null,null,`#${a.data.name}-${e}`)})})}}));h.start();
