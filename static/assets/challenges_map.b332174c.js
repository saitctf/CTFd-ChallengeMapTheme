import{m as p,C as r,h as $,T as f,d as k,M as w,a as C}from"./index.b6be5691.js";function M(){return new Promise((e,n)=>{const a=()=>window.$||window.jQuery,t=a();if(window.Raphael&&t&&t.mapael&&t.mapael.maps&&t.mapael.maps.france){e();return}let l=0;const s=100,o=setInterval(()=>{l++;const c=a();if(window.Raphael&&c&&c.mapael&&c.mapael.maps&&c.mapael.maps.france)clearInterval(o),e();else if(l>=s){clearInterval(o),console.error("Map libraries not loaded after waiting"),console.log("Raphael:",!!window.Raphael),console.log("jQuery ($):",!!window.$),console.log("jQuery (jQuery):",!!window.jQuery);const i=a();console.log("Mapael:",!!(i&&i.mapael)),console.log("Available maps:",i&&i.mapael&&i.mapael.maps?Object.keys(i.mapael.maps):"none"),n(new Error("Map libraries not loaded"))}},100)})}function b(e){let a=new DOMParser().parseFromString(e,"text/html");return a.querySelectorAll('a[href*="://"]').forEach(l=>{l.setAttribute("target","_blank")}),a.documentElement.outerHTML}window.Alpine=p;p.store("challenge",{data:{view:""}});p.data("Hint",()=>({id:null,html:null,async showHint(e){if(e.target.open){let n=await r.pages.challenge.loadHint(this.id);if(n.errors){e.target.open=!1,r._functions.challenge.displayUnlockError(n);return}let a=n.data;if(a.content)this.html=b(a.html);else if(await r.pages.challenge.displayUnlock(this.id)){let l=await r.pages.challenge.loadUnlock(this.id);if(l.success){let o=(await r.pages.challenge.loadHint(this.id)).data;this.html=b(o.html)}else e.target.open=!1,r._functions.challenge.displayUnlockError(l)}else e.target.open=!1}}}));p.data("Challenge",()=>({id:null,next_id:null,submission:"",tab:null,solves:[],submissions:[],solution:null,response:null,share_url:null,max_attempts:0,attempts:0,ratingValue:0,hoveredRating:0,selectedRating:0,ratingReview:"",ratingSubmitted:!1,async init(){$()},getStyles(){let e={"modal-dialog":!0};try{switch(r.config.themeSettings.challenge_window_size){case"sm":e["modal-sm"]=!0;break;case"lg":e["modal-lg"]=!0;break;case"xl":e["modal-xl"]=!0;break;default:break}}catch(n){console.log("Error processing challenge_window_size"),console.log(n)}return e},async showChallenge(){new f(this.$el).show()},async showSolves(){this.solves=await r.pages.challenge.loadSolves(this.id),this.solves.forEach(e=>(e.date=k(e.date).format("MMMM Do, h:mm:ss A"),e)),new f(this.$el).show()},async showSubmissions(){let e=await r.pages.users.userSubmissions("me",this.id);this.submissions=e.data,this.submissions.forEach(n=>(n.date=k(n.date).format("MMMM Do, h:mm:ss A"),n)),new f(this.$el).show()},getSolutionId(){return p.store("challenge").data.solution_id},async showSolution(){let e=this.getSolutionId();r._functions.challenge.displaySolution=n=>{this.solution=n.html,new f(this.$el).show()},await r.pages.challenge.displaySolution(e)},getNextId(){return p.store("challenge").data.next_id},async nextChallenge(){let e=w.getOrCreateInstance("[x-ref='challengeWindow']");e._element.addEventListener("hidden.bs.modal",n=>{p.nextTick(()=>{this.$dispatch("load-challenge",this.getNextId())})},{once:!0}),e.hide()},async getShareUrl(){let e={type:"solve",challenge_id:this.id};const t=(await(await r.fetch("/api/v1/shares",{method:"POST",body:JSON.stringify(e)})).json()).data.url;this.share_url=t},copyShareUrl(){navigator.clipboard.writeText(this.share_url);let e=C.getOrCreateInstance(this.$el);e.enable(),e.show(),setTimeout(()=>{e.hide(),e.disable()},2e3)},async submitChallenge(){this.response=await r.pages.challenge.submitChallenge(this.id,this.submission),await this.renderSubmissionResponse()},async renderSubmissionResponse(){this.response.data.status==="correct"&&(this.submission=""),this.max_attempts>0&&this.response.data.status!="already_solved"&&this.response.data.status!="ratelimited"&&(this.attempts+=1),this.$dispatch("load-challenges")},async submitRating(){(await r.pages.challenge.submitRating(this.id,this.selectedRating,this.ratingReview)).value?(this.ratingValue=this.selectedRating,this.ratingSubmitted=!0):alert("Error submitting rating")}}));p.data("ChallengeMap",()=>({loaded:!1,challenges:[],challenge:null,provinces:{},provinces_used:[],chal_areas:{},categories:[],category_colors:[],province_challenges:{},chal_plots:{},province_centers:{},async init(){try{if(this.challenges=await r.pages.challenges.getChallenges(),await M().catch(e=>{console.error("Failed to load map libraries:",e),this.loaded=!0}),this.loaded=!0,this.initializeMap(),window.location.hash){let e=decodeURIComponent(window.location.hash.substring(1)),n=e.lastIndexOf("-");if(n>=0){let t=[e.slice(0,n),e.slice(n+1)][1];await this.loadChallenge(t)}}}catch(e){console.error("Error initializing challenge map:",e),this.loaded=!0}},initializeMap(){const e=window.$||window.jQuery,n=e&&e.mapael&&e.mapael.maps&&e.mapael.maps.france&&e.mapael.maps.france.elems?Object.keys(e.mapael.maps.france.elems):[];this.provinces={},n.forEach((a,t)=>{this.provinces[a]=t+1}),this.province_centers={department_29:{x:20.9,y:97.6},department_22:{x:57.1,y:91.4},department_56:{x:59.5,y:119},department_35:{x:102.9,y:96.7},department_44:{x:118,y:134.1},department_50:{x:101,y:55.1},department_53:{x:167.5,y:104.2},department_49:{x:127,y:134},department_85:{x:125.8,y:166.5},department_79:{x:166.8,y:165.3},department_17:{x:125.5,y:196.7},department_33:{x:133.5,y:226.4},department_40:{x:132.2,y:273.7},department_64:{x:169.3,y:314.4},department_65:{x:174.6,y:313.7},department_32:{x:198.7,y:295},department_47:{x:184.8,y:265.4},department_31:{x:234.5,y:300.3},department_09:{x:228,y:327.1},department_11:{x:261.9,y:319.9},department_34:{x:318.5,y:297.4},department_81:{x:258.4,y:288.8},department_82:{x:219.3,y:281.4},department_12:{x:278.9,y:255.8},department_46:{x:235.5,y:253.1},department_24:{x:199.4,y:225.7},department_16:{x:203.3,y:206.5},department_86:{x:175.1,y:161},department_37:{x:199.3,y:138.6},department_72:{x:187,y:106.8},department_61:{x:189.9,y:87.2},department_27:{x:195,y:65.4},department_14:{x:183,y:67.7},department_76:{x:226.8,y:39.4},department_60:{x:242.4,y:53.9},department_80:{x:236.1,y:29},department_95:{x:244.2,y:78.5},department_78:{x:238.7,y:84},department_28:{x:232.5,y:87.6},department_75:{x:269.2,y:91.9},department_93:{x:277.2,y:88.5},department_94:{x:273.7,y:94.7},department_92:{x:265.4,y:91},department_91:{x:263.4,y:97.2},department_45:{x:258.2,y:112.3},department_41:{x:212.7,y:122.3},department_36:{x:237.6,y:157.8},department_18:{x:261.5,y:141.1},department_23:{x:243.6,y:193.4},department_87:{x:230.7,y:198},department_19:{x:255.8,y:223},department_15:{x:272.9,y:234.3},department_30:{x:326.6,y:276.6},department_48:{x:306.4,y:256.8},department_63:{x:284.9,y:201},department_42:{x:325.4,y:201.6},department_69:{x:356.2,y:199.5},department_43:{x:309.9,y:236.8},department_07:{x:358.5,y:237.5},department_26:{x:366,y:238.4},department_84:{x:362.9,y:279.7},department_13:{x:352.2,y:299.5},department_83:{x:424.8,y:306.3},department_06:{x:439.2,y:281.7},department_04:{x:438.4,y:268.8},department_05:{x:417.3,y:251.6},department_38:{x:379.9,y:216.1},department_73:{x:401.6,y:216.9},department_74:{x:429,y:194.3},department_71:{x:336,y:161.7},department_03:{x:289.5,y:177},department_58:{x:295.4,y:145.7},department_89:{x:304.3,y:110.3},department_77:{x:294.3,y:81.4},department_10:{x:339.5,y:98.5},department_51:{x:330,y:68},department_02:{x:315.8,y:40.9},department_59:{x:270.1,y:28.8},department_62:{x:248.6,y:.5},department_08:{x:359,y:35.8},department_55:{x:383,y:58.7},department_54:{x:394,y:61.6},department_57:{x:409.6,y:63.7},department_67:{x:445.4,y:81.7},department_88:{x:445.3,y:105.5},department_52:{x:364.9,y:99.5},department_70:{x:409.2,y:126.9},department_21:{x:348.9,y:125.9},department_25:{x:429.4,y:144.8},department_2B:{x:485.7,y:324.3},department_2A:{x:454.5,y:352.9},department_66:{x:282.4,y:342.7},department_01:{x:363.8,y:188.7},department_39:{x:387.6,y:157.7},department_68:{x:452.5,y:115},department_90:{x:440.3,y:138.2}},this.provinces_used=[],this.chal_areas={},this.categories=[],this.category_colors=[],this.province_challenges={},this.chal_plots={},this.mapChallengesToProvinces(),this.createMap()},mapChallengesToProvinces(){const e=Object.keys(this.provinces),n={},a={};this.challenges.forEach((t,l)=>{this.categories.includes(t.category)||this.categories.push(t.category);let s=null;const o=this.categories.indexOf(t.category);s=e[o%e.length],n[t.category]||(n[t.category]=s,this.provinces_used.includes(s)||this.provinces_used.push(s),a[s]||(a[s]=[]),this.chal_areas[s]={value:t.category,tooltip:{content:`<span style="font-weight:bold;">${t.category}</span>`}},this.provinces[s]=t.id),a[s]||(a[s]=[]),a[s].push(t),this.province_challenges[s]||(this.province_challenges[s]=[]),this.province_challenges[s].includes(t.id)||this.province_challenges[s].push(t.id);const c=this.province_centers[s];if(c){const i=a[s],m=i.indexOf(t),y=i.length,d=Math.ceil(Math.sqrt(y)),g=Math.floor(m/d),h=(m%d-(d-1)/2)*25,x=(g-Math.floor((y-1)/d)/2)*25,v=`chal_${t.id}`,u=t.solved_by_me||!1;this.chal_plots[v]={x:c.x+h,y:c.y+x,size:12,type:"circle",attrs:{fill:u?"#0066b1":"#fff773",stroke:"#8b5c29","stroke-width":2,opacity:u?.8:1},attrsHover:{opacity:1,fill:u?"#0088dd":"#ffff99","stroke-width":3},tooltip:{content:`<span style="font-weight:bold;">${t.name}</span><br/>${parseInt(t.value)} points<br/>${t.category}${u?'<br/><span style="color:#0066b1;">\u2713 Solved</span>':""}`},challengeId:t.id,isSolved:u}}}),this.challenges.forEach(t=>{t.tags.forEach(l=>{const s=l.value.toUpperCase();if(this.provinces.hasOwnProperty(s)){const o=n[t.category];if(o&&this.province_challenges[o]){const i=this.province_challenges[o].indexOf(t.id);i>-1&&this.province_challenges[o].splice(i,1)}this.province_challenges[s]||(this.province_challenges[s]=[]),this.province_challenges[s].includes(t.id)||this.province_challenges[s].push(t.id);const c=`chal_${t.id}`;if(this.chal_plots[c]&&this.province_centers[s]){const i=this.province_centers[s],m=this.province_challenges[s],y=m.indexOf(t.id),d=m.length,g=Math.ceil(Math.sqrt(d)),_=Math.floor(y/g),x=(y%g-(g-1)/2)*25,v=(_-Math.floor((d-1)/g)/2)*25;this.chal_plots[c].x=i.x+x,this.chal_plots[c].y=i.y+v}this.provinces_used.includes(s)||(this.chal_areas[s]={value:t.category,tooltip:{content:`<span style="font-weight:bold;">${t.category} ${parseInt(t.value)}: ${t.name}</span>`}},this.provinces_used.push(s),this.provinces[s]=t.id)}})}),this.categories.forEach(t=>{this.category_colors.push({attrs:{fill:this.colorHash(t)},label:t,sliceValue:t})}),Object.keys(this.chal_areas).length===0&&console.log("No challenges found, showing empty map")},colorHash(e){let n=0;for(let l=0;l<e.length;l++)n+=e.charCodeAt(l);let a="";const t=n/8;for(let l=t;l<=n&&(a+=l.toString(16).replace(/\W/g,""),!(a.length>=6));l+=t);return"#"+a.substring(0,6)},createMap(){const e=this,n=()=>{const a=e.$refs.mapContainer;if(!a){setTimeout(n,50);return}const t=window.$||window.jQuery;if(!t){setTimeout(n,50);return}const l=t(a),s=l.find(".map"),o=l.is(":visible")&&l.width()>0&&l.height()>0&&window.getComputedStyle(a).display!=="none",c=s.length>0&&s.is(":visible")&&window.getComputedStyle(s[0]).display!=="none";if(!o||!c){setTimeout(n,100);return}if(!t.mapael){console.error("jQuery Mapael not loaded");return}if(!t.mapael.maps||!t.mapael.maps.france){console.error("France map definition not found"),console.log("Available maps:",t.mapael.maps?Object.keys(t.mapael.maps):"none");return}try{const i={map:{name:"france",cssClass:"map",defaultArea:{attrs:{fill:"#8b5c29",stroke:"#ffe1ba",strokeWidth:2,cursor:"pointer"},text:{attrs:{"font-size":12,"font-family":"Arial, Helvetica, sans-serif",fill:"#fff773"},attrsHover:{"font-size":14,"font-family":"Arial, Helvetica, sans-serif",fill:"#fff773"}},attrsHover:{animDuration:200,fill:"#a66d3a"},eventHandlers:{click:(y,d,g,_)=>{if(!e.provinces_used.includes(d)){console.log("Province",d,"has no challenges assigned");return}const h=e.province_challenges[d]||[e.provinces[d]];h.length===1?e.loadChallenge(h[0]):e.showChallengeSelection(d,h)}}},defaultPlot:{size:12,attrs:{fill:"#fff773",stroke:"#8b5c29","stroke-width":2},attrsHover:{opacity:1,fill:"#ffff99","stroke-width":3},eventHandlers:{click:function(y,d,g,_){const h=e.chal_plots[d];h&&h.challengeId&&e.loadChallenge(h.challengeId)}}}},legend:{area:{title:"Categories",slices:e.category_colors}},areas:e.chal_areas,plots:e.chal_plots};console.log("Creating map with config:",i),console.log("Areas to render:",Object.keys(e.chal_areas)),console.log("Plots to render:",Object.keys(e.chal_plots)),console.log("Map container:",a),console.log("Container dimensions:",l.width(),"x",l.height()),console.log("Map div dimensions:",s.width(),"x",s.height());const m=t(a).mapael(i);setTimeout(()=>{e.addCheckmarksToSolvedChallenges(t(a))},200),console.log("Map created successfully")}catch(i){console.error("Error creating map:",i),console.error("Error stack:",i.stack)}};this.$nextTick(()=>{setTimeout(n,100)})},async loadChallenges(){this.challenges=await r.pages.challenges.getChallenges(),this.initializeMap()},async showChallengeSelection(e,n){const a=this.challenges.filter(i=>n.includes(i.id));if(a.length===0)return;const t=`
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Select Challenge - ${e}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>This province has ${a.length} challenge${a.length>1?"s":""}:</p>
            <div class="list-group">
              ${a.map(i=>`
                <button type="button" class="list-group-item list-group-item-action" data-challenge-id="${i.id}">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${i.name}</h6>
                    <small>${parseInt(i.value)} points</small>
                  </div>
                  <p class="mb-1">${i.category}</p>
                </button>
              `).join("")}
            </div>
          </div>
        </div>
      </div>
    `,l=document.createElement("div");l.className="modal fade",l.id="challenge-selection-modal",l.innerHTML=t,document.body.appendChild(l);const s=new w(l,{backdrop:!0,keyboard:!0});let o=null;l.querySelectorAll("[data-challenge-id]").forEach(i=>{i.addEventListener("click",()=>{o=parseInt(i.getAttribute("data-challenge-id")),s.hide()})});const c=i=>{o&&setTimeout(()=>{this.loadChallenge(o)},150);try{s.dispose()}catch{}requestAnimationFrame(()=>{requestAnimationFrame(()=>{try{l&&l.isConnected&&l.parentNode&&l.remove()}catch{}})})};l.addEventListener("hidden.bs.modal",c,{once:!0}),s.show()},addCheckmarksToSolvedChallenges(e){Object.keys(this.chal_plots).forEach(n=>{const a=this.chal_plots[n];if(a&&a.isSolved){const t=e.data("mapael");if(t&&t.paper){const s=t.paper.path(`M ${a.x-10},${a.y} L ${a.x-2},${a.y+8} L ${a.x+10},${a.y-8}`).attr({stroke:"#0066b1","stroke-width":4,"stroke-linecap":"round","stroke-linejoin":"round",fill:"none"});a.checkmark=s}}})},async loadChallenge(e){const n=this;await r.pages.challenge.displayChallenge(e,a=>{a.data.view=b(a.data.view),p.store("challenge").data=a.data,p.nextTick(()=>{let t=w.getOrCreateInstance("[x-ref='challengeWindow']");t._element.addEventListener("hidden.bs.modal",l=>{history.replaceState(null,null," "),n.initializeMap()},{once:!0}),t.show(),history.replaceState(null,null,`#${a.data.name}-${e}`)})})}}));p.start();
